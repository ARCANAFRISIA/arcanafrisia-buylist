generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  directUrl         = env("DIRECT_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

model Product {
  id        BigInt    @id
  name      String
  setCode   String?
  lang      String    @default("EN")
  isFoil    Boolean   @default(false)
  scarcity  String?
  cmTrend   Decimal?
  cmTrendAt DateTime?
}

model PriceGuide {
  id        String   @id @default(cuid())
  productId Int      @unique
  trend     Decimal?
  trendFoil Decimal?
  source    String?  @default("Cardmarket")
  isCurrent Boolean  @default(true)
  createdAt DateTime @default(now())
}

model Submission {
  id               String           @id @default(cuid())
  email            String?
  status           String           @default("RECEIVED")
  subtotalCents    Int
  serverTotalCents Int
  clientTotalCents Int?
  payoutPct        Int
  currency         String           @default("EUR")
  pricingSource    String           @default("Cardmarket")
  metaText         String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  items            SubmissionItem[]
}

model SubmissionItem {
  id             String     @id @default(cuid())
  submissionId   String
  productId      BigInt
  isFoil         Boolean    @default(false)
  qty            Int
  trendCents     Int?
  trendFoilCents Int?
  unitCents      Int
  lineCents      Int
  pct            Int?
  Submission     Submission @relation(fields: [submissionId], references: [id])

  @@index([submissionId])
  @@index([productId])
}

model CTMarketSummary {
  id           Int      @id @default(autoincrement())
  capturedAt   DateTime @default(now())
  blueprintId  Int
  cardmarketId Int?
  scryfallId   String?
  bucket       String
  isFoil       Boolean
  currency     String   @default("EUR")
  minPrice     Decimal? @db.Decimal(10, 2)
  medianPrice  Decimal? @db.Decimal(10, 2)
  offerCount   Int      @default(0)

  @@unique([blueprintId, bucket, isFoil, capturedAt])
  @@index([capturedAt], name: "idx_ctsummary_captured")
  @@index([blueprintId, isFoil, bucket, capturedAt], name: "idx_ctsummary_key_captured")
}

model CTMarketLatest {
  blueprintId  Int
  bucket       String
  isFoil       Boolean
  capturedAt   DateTime
  minPrice     Float?
  medianPrice  Float?
  offerCount   Int?
  cardmarketId Int? // handig om mee te nemen
  scryfallId   String? // idem

  @@id([blueprintId, bucket, isFoil]) // een enkele “laatste” snapshot per key
}

model BlueprintMapping {
  blueprintId     Int      @id
  expansionId     Int
  name            String?
  collectorNumber String?
  cardmarketId    Int?
  scryfallId      String?
  updatedAt       DateTime @updatedAt
  foil            Boolean?
  setCode         String?

  @@index([scryfallId])
  @@index([setCode, collectorNumber])
  @@index([cardmarketId])
}

model CTRefreshCursor {
  id        Int      @id @default(1)
  offset    Int      @default(0)
  pageSize  Int      @default(250)
  updatedAt DateTime @updatedAt
}

model ScryfallCard {
  id              String    @id
  name            String
  set             String
  collectorNumber String
  finishes        String[]
  imageSmall      String?
  imageNormal     String?
  releasedAt      DateTime? @db.Timestamp(6)
  cardmarketId    Int?

  @@index([name, set, collectorNumber])
}

model CMPriceGuide {
  cardmarketId Int @id

  trend        Float?
  foilTrend    Float?
  lowEx        Float?
  suggested    Float?
  germanProLow Float?

  avg1      Float?
  avg7      Float?
  avg30     Float?
  foilAvg1  Float?
  foilAvg7  Float?
  foilAvg30 Float?

  updatedAt DateTime @updatedAt
}

model CMPriceGuideQueue {
  id        Int      @id @default(autoincrement())
  line      String // ruwe CSV-regel
  createdAt DateTime @default(now())
}

model ScryfallLookup {
  cardmarketId    Int      @id
  scryfallId      String
  oracleId        String?
  name            String
  set             String
  collectorNumber String?
  lang            String?
  imageSmall      String?
  imageNormal     String?
  rarity          String?
  usd             Float?
  eur             Float?
  tix             Float?
  updatedAt       DateTime @updatedAt
}

model ScryfallLookupQueue {
  id           Int       @id @default(autoincrement())
  cardmarketId Int       @unique
  attempts     Int       @default(0)
  createdAt    DateTime  @default(now())
  nextTryAt    DateTime?
  processedAt  DateTime?
  lastError    String?
  notFound     Boolean   @default(false)
}

model CTOrder {
  id            Int       @id @default(autoincrement())
  ctOrderId     Int       @unique
  state         String
  paidAt        DateTime?
  sentAt        DateTime?
  creditAddedAt DateTime? // payout naar verkoper
  currency      String    @default("EUR")

  sellerTotalEur    Decimal? // seller_total.cents / 100
  sellerSubtotalEur Decimal? // seller_subtotal.cents / 100 (som lines)
  sellerFeeEur      Decimal? // seller_fee_amount.cents / 100
  shippingEur       Decimal? // order_shipping_method.seller_price.cents / 100

  lineItems CTOrderLine[]

  createdAtDb DateTime @default(now())
  updatedAtDb DateTime @updatedAt
}

model CTOrderLine {
  id      Int     @id @default(autoincrement())
  orderId Int
  order   CTOrder @relation(fields: [orderId], references: [id])

  ctLineId     Int     @unique // <-- NIEUW: CT's eigen line-item id
  blueprintId  Int?
  cardmarketId Int?
  scryfallId   String?
  isFoil       Boolean @default(false)
  condition    String?

  quantity     Int
  unitPriceEur Decimal
  lineGrossEur Decimal

  createdAt  DateTime?
  commentRaw String?

  createdAtDb        DateTime  @default(now())
  updatedAtDb        DateTime  @updatedAt
  
}

model SalesLog {
  id Int @id @default(autoincrement())

  source     String
  externalId String

  ts DateTime

  orderId   Int?
  ctOrderId Int? // <-- alleen dit is de inhoudelijke wijziging (nullable)
  cmOrderId Int?

  cardmarketId Int?
  blueprintId  Int?
  scryfallId   String?
  isFoil       Boolean?
  condition    String?
  qty          Int

  // Laat je geldkolommen op DECIMAL zoals ze nu zijn, zodat er geen casts nodig zijn:
  unitPriceEur Decimal? @db.Decimal(65, 30)
  lineTotalEur Decimal? @db.Decimal(65, 30)
  shippingEur  Decimal? @db.Decimal(65, 30)
  feeEur       Decimal? @db.Decimal(65, 30)

  comment    String?
  sourceCode String?
  sourceDate DateTime?

  createdAt DateTime? @default(now()) @map("createdAtDb")
  updatedAt DateTime  @default(now()) @updatedAt @map("updatedAtDb")
  inventoryAppliedAt DateTime?

  @@unique([source, externalId], name: "source_externalId")
}

model CMOrder {
  id             Int       @id @default(autoincrement())
  cmOrderId      Int       @unique
  state          String
  dateBought     DateTime? @db.Timestamptz(3)
  datePaid       DateTime? @db.Timestamptz(3)
  dateSent       DateTime? @db.Timestamptz(3)
  dateReceived   DateTime? @db.Timestamptz(3)
  currency       String? // normaal "EUR"
  totalValueEur  Float?
  articleCount   Int?
  buyerUsername  String?
  sellerUsername String?

  lines CMOrderLine[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CMOrderLine {
  id       Int     @id @default(autoincrement())
  cmLineId Int     @unique // idArticle
  orderId  Int
  order    CMOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)

  cardmarketId Int? // idProduct
  isFoil       Boolean?
  condition    String?
  language     String?
  expansion    String?
  quantity     Int
  unitPriceEur Float
  lineGrossEur Float
  commentRaw   String?

  createdAt DateTime? @db.Timestamptz(3)

  // optioneel: scryfallId/blueprintId als je al mapping hebt
  blueprintId Int?
  scryfallId  String?

  @@index([orderId])
  @@index([cardmarketId])
}

model InventoryLot {
  id             String   @id @default(cuid())
  cardmarketId   Int
  isFoil         Boolean  @default(false)
  condition      String
  qtyIn          Int
  qtyRemaining   Int
  avgUnitCostEur Decimal  @db.Decimal(10, 4)
  sourceCode     String
  sourceDate     DateTime
  location       String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([cardmarketId, isFoil, condition])
}

model InventoryBalance {
  id             String    @id @default(cuid())
  cardmarketId   Int
  isFoil         Boolean   @default(false)
  condition      String
  qtyOnHand      Int       @default(0)
  avgUnitCostEur Decimal?  @db.Decimal(10, 4)
  lastSaleAt     DateTime?
  updatedAt      DateTime  @updatedAt
  createdAt      DateTime  @default(now())

  @@unique([cardmarketId, isFoil, condition])
}

model InventoryTxn {
  id            String   @id @default(cuid())
  ts            DateTime @default(now())
  kind          String // "LOT_IN" | "SALE_OUT" | "ADJUST"
  cardmarketId  Int
  isFoil        Boolean  @default(false)
  condition     String
  qty           Int
  unitCostEur   Decimal? @db.Decimal(10, 4)
  refSource     String?
  refExternalId String?
}

model SyncCursor {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}
