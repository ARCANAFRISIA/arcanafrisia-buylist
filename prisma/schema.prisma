generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id        BigInt    @id
  name      String
  setCode   String?
  lang      String    @default("EN")
  isFoil    Boolean   @default(false)
  scarcity  String?
  cmTrend   Decimal?
  cmTrendAt DateTime?
}

model PriceGuide {
  id        String   @id @default(cuid())
  productId Int      @unique
  trend     Decimal?
  trendFoil Decimal?
  source    String?  @default("Cardmarket")
  isCurrent Boolean  @default(true)
  createdAt DateTime @default(now())
}

model Submission {
  id               String           @id @default(cuid())
  email            String?
  status           String           @default("RECEIVED")
  subtotalCents    Int
  serverTotalCents Int
  clientTotalCents Int?
  payoutPct        Int
  currency         String           @default("EUR")
  pricingSource    String           @default("Cardmarket")
  metaText         String?
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  items            SubmissionItem[]
}

model SubmissionItem {
  id             String     @id @default(cuid())
  submissionId   String
  productId      BigInt
  isFoil         Boolean    @default(false)
  qty            Int
  trendCents     Int?
  trendFoilCents Int?
  unitCents      Int
  lineCents      Int
  pct            Int?
  Submission     Submission @relation(fields: [submissionId], references: [id])

  @@index([submissionId])
  @@index([productId])
}

model CTMarketSummary {
  id           Int      @id @default(autoincrement())
  capturedAt   DateTime @default(now())
  blueprintId  Int
  cardmarketId Int?
  scryfallId   String?
  bucket       String
  isFoil       Boolean
  currency     String   @default("EUR")
  minPrice     Decimal? @db.Decimal(10, 2)
  medianPrice  Decimal? @db.Decimal(10, 2)
  offerCount   Int      @default(0)

  @@unique([blueprintId, bucket, isFoil, capturedAt])
  @@index([capturedAt])
}

model BlueprintMapping {
  blueprintId     Int      @id
  expansionId     Int
  name            String?
  collectorNumber String?
  cardmarketId    Int?
  scryfallId      String?
  updatedAt       DateTime
  foil            Boolean?
  setCode         String?

  @@index([setCode, foil])
  @@index([expansionId])
}

model CTRefreshCursor {
  id        Int      @id @default(1)
  offset    Int      @default(0)
  pageSize  Int      @default(250)
  updatedAt DateTime @updatedAt
}

model ScryfallCard {
  id              String    @id
  name            String
  set             String
  collectorNumber String
  finishes        String[]
  imageSmall      String?
  imageNormal     String?
  releasedAt      DateTime? @db.Timestamp(6)
  cardmarketId    Int?

  @@index([name, set, collectorNumber])
}
